{% extends "layout.html" %}

{% block title %}Scan Réseau - Moniteur de Sécurité Réseau{% endblock %}
{% block page_title %}Scan Réseau{% endblock %}

{% block content %}
<div class="page-content">
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-network-wired"></i>
                Lancer un Scan Réseau
            </h3>
        </div>
        <div class="card-body">
            <div class="tabs">
                <button class="tab-button active" onclick="showScanType('full')">
                    <i class="fas fa-sitemap"></i> Scan Complet du Réseau
                </button>
                <button class="tab-button" onclick="showScanType('manual')">
                    <i class="fas fa-crosshairs"></i> Scan de Ports (Hôte Spécifique)
                </button>
            </div>

            <form id="scanForm" onsubmit="handleScan(event)">

                <div id="fullScanSection" class="tab-content active" style="margin-top: 1rem;">
                    <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        Détecte les hôtes actifs sur une plage réseau et scanne les ports.
                    </p>
                    <div class="form-group">
                        <label class="form-label" for="targetRange">Plage Réseau (CIDR)</label>
                        <input type="text" class="form-input" id="targetRange" name="target" value="192.168.1.0/24"
                            placeholder="ex: 192.168.1.0/24" required>
                        <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">
                            Format: XXX.XXX.XXX.XXX/XX
                        </small>
                    </div>
                </div>

                <div id="manualScanSection" class="tab-content" style="margin-top: 1rem; display: none;">
                    <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        Scanne les ports d'une adresse IP spécifique.
                    </p>
                    <div class="form-group">
                        <label class="form-label" for="hostIP">Adresse IP Cible</label>
                        <input type="text" class="form-input" id="hostIP" name="target" placeholder="ex: 192.168.1.1"
                            required disabled>
                        <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">
                            Format: XXX.XXX.XXX.XXX
                        </small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="portsRange">Plage de Ports</label>
                    <input type="text" class="form-input" id="portsRange" value="1-100"
                        placeholder="ex: 1-100 ou 80,443,8080">
                    <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">
                        Format: 1-100, 80,443,8080 ou 1-65535
                    </small>
                </div>

                <hr style="margin: 2rem 0;">

                <h4 style="margin-bottom: 1.5rem; color: var(--text-primary);"><i class="fas fa-sliders-h"></i> Options
                    de Scan</h4>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label" for="detection">Options de Détection</label>
                        <select class="form-select" id="detection">
                            <option value="none" selected>Standard (Ports/Hôtes)</option>
                            <option value="services">Services, Versions, OS</option>
                        </select>
                        <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">Détection:
                            Services, Versions, OS.</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="scanMethod">Méthode de Scan</label>
                        <select class="form-select" id="scanMethod">
                            <option value="connect" selected>Connect Scan (-sT) [Fiable]</option>
                            <option value="syn">SYN Scan (-sS) [Rapide]</option>
                        </select>
                        <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">
                            Connect: Standard Windows. SYN: Stealth / Root.
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="format">Format des Résultats</label>
                        <select class="form-select" id="format">
                            <option value="normal" selected>Normal</option>
                            <option value="detailed">Détaillé</option>
                            <option value="xml">XML</option>
                            <option value="json">JSON</option>
                        </select>
                        <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">Format de sortie
                            pour les résultats.</small>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary btn-block" id="scanBtn">
                        <i class="fas fa-play"></i> Lancer le Scan
                    </button>
                    <button type="button" class="btn btn-danger btn-block" id="stopBtn" onclick="handleStop()"
                        style="display: none;">
                        <i class="fas fa-stop"></i> Arrêter le Scan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-info-circle"></i>
                Statut du Scan
            </h3>
        </div>
        <div class="card-body">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="scanStatusIndicator"
                    style="width: 12px; height: 12px; border-radius: 50%; background-color: var(--success-color);">
                </div>
                <div>
                    <div style="font-weight: 600; color: var(--text-primary);" id="scanStatusText">Prêt</div>
                    <div style="font-size: 0.875rem; color: var(--text-tertiary);" id="scanStatusDetail">Aucun scan en
                        cours</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-list"></i>
                Résultats du Scan
            </h3>
            <button class="btn btn-secondary btn-small" onclick="refreshResults()">
                <i class="fas fa-sync-alt"></i> Rafraîchir
            </button>
        </div>
        <div class="card-body" id="resultsContainer">
            <p style="text-align: center; color: var(--text-tertiary); padding: 2rem;">
                <i class="fas fa-inbox" style="font-size: 2rem; display: block; margin-bottom: 1rem; opacity: 0.5;"></i>
                Aucun résultat de scan. Lancez un scan pour voir les résultats.
            </p>
        </div>
    </div>
</div>

<style>
    /* Styles pour les Onglets */
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .tab-button {
        padding: 0.75rem 1.5rem;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
    }

    .tab-button:hover {
        color: var(--text-primary);
    }

    .tab-button.active {
        color: var(--primary-color);
        border-bottom: 3px solid var(--primary-color);
    }

    .tab-content {
        /* Assure que la section active s'affiche et l'autre est masquée */
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Style pour la grille des options */
    .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
    }
</style>

<script>
    let currentScanType = 'full'; // État pour suivre le type de scan actif

    // Fonction pour gérer le changement d'onglet
    function showScanType(type) {
        currentScanType = type;

        // Gérer l'affichage des sections
        document.getElementById('fullScanSection').style.display = (type === 'full') ? 'block' : 'none';
        document.getElementById('manualScanSection').style.display = (type === 'manual') ? 'block' : 'none';

        // Gérer les boutons d'onglet actifs
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-button:nth-child(${type === 'full' ? 1 : 2})`).classList.add('active');

        // Gérer les attributs 'required' et 'disabled' pour la validation
        document.getElementById('targetRange').required = (type === 'full');
        document.getElementById('targetRange').disabled = (type !== 'full');
        document.getElementById('hostIP').required = (type === 'manual');
        document.getElementById('hostIP').disabled = (type !== 'manual');

        // Mettre à jour le texte du bouton de soumission
        document.getElementById('scanBtn').innerHTML = `<i class="fas fa-play"></i> Lancer le Scan ${type === 'full' ? 'Complet' : 'Manuel'}`;
    }

    // Initialiser l'affichage au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
        showScanType('full');
        // On page load, try to restore results if available, or check status
        refreshResults();
        pollScanStatus();
    });

    // Fonction principale pour gérer la soumission du formulaire
    async function handleScan(event) {
        event.preventDefault();

        const ports = document.getElementById('portsRange').value;
        const detection = document.getElementById('detection').value;
        // speed est retiré, on utilise hardcoded 'T4' dans le backend ou on l'envoie manuellement si on veut garder l'API générique
        // const speed = document.getElementById('speed').value; 
        const scan_method = document.getElementById('scanMethod').value;
        const format = document.getElementById('format').value;
        let target;
        let scanFunction;

        // Structure simple pour l'appel API
        // On n'envoie PAS 'speed' car le select n'existe plus
        // Le backend (app.py) mettra la vitesse par défaut.

        if (currentScanType === 'full') {
            target = document.getElementById('targetRange').value;
            scanFunction = API.scanner.performFullScan;
            if (!isValidCIDR(target)) {
                Toast.error('Format CIDR invalide. Utilisez XXX.XXX.XXX.XXX/XX');
                return;
            }
        } else { // manual
            target = document.getElementById('hostIP').value;
            scanFunction = API.scanner.scanPorts;
            if (!isValidIP(target)) {
                Toast.error('Adresse IP invalide');
                return;
            }
        }

        try {
            updateScanStatus(true, `Démarrage du scan ${currentScanType === 'full' ? 'Complet' : 'Manuel'} sur ${target}...`);
            document.getElementById('scanBtn').disabled = true;

            // Clear previous results and show loading state with a nice spinner
            document.getElementById('resultsContainer').innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                    <p style="color: var(--text-secondary); font-size: 1.1rem;">Scan en cours...</p>
                    <p style="color: var(--text-tertiary);">Analyse de ${target}</p>
                </div>
            `;

            const endpoint = currentScanType === 'full' ? '/api/scan/full' : '/api/scan/ports';
            const payload = {
                ports: ports,
                scan_method: scan_method
            };

            if (currentScanType === 'full') {
                payload.target_range = target;
            } else {
                payload.host_ip = target;
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                Toast.success('Scan lancé avec succès');
                pollScanStatus();
            } else {
                // If the server says "Scan already in progress" (400), we should probably just poll
                if (response.status === 400 && data.error === 'Un scan est déjà en cours') {
                    Toast.info('Un scan est déjà en cours, récupération du statut...');
                    pollScanStatus();
                } else {
                    throw new Error(data.error || 'Erreur inconnue');
                }
            }

        } catch (error) {
            Toast.error('Erreur lors du scan: ' + (error.message || 'Problème de connexion'));
            // Only reset status/button if we really failed to start or connect
            // If it was just a polling error later, pollScanStatus handles it.
            // But here we might be in the 'start scan' phase. 
            // If error is "Scan already in progress", we shouldn't reset to error.
            if (error.message !== 'Un scan est déjà en cours') {
                updateScanStatus(false, 'Erreur');
                // Don't clear the "Loading" state if we want to show error? 
                // Restore empty state or show error in results?
                document.getElementById('resultsContainer').innerHTML = `
                    <p style="text-align: center; color: var(--danger-color); padding: 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; display: block; margin-bottom: 1rem;"></i>
                        Erreur: ${error.message}
                    </p>
                `;
            }
        }
    }

    async function handleStop() {
        if (!confirm('Voulez-vous vraiment arrêter le scan en cours ?')) return;

        try {
            const response = await fetch('/api/scan/stop', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                Toast.info('Arrêt du scan demandé...');
                // The polling will pick up the status change eventually, but let's force UI update slightly
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('stopBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Arrêt...';
            } else {
                Toast.error('Erreur: ' + data.error);
            }
        } catch (error) {
            console.error('Stop error:', error);
            Toast.error('Erreur de connexion');
        }
    }

    async function pollScanStatus() {
        try {
            const status = await API.scanner.getStatus();

            if (status.in_progress) {
                updateScanStatus(true, status.status || 'En cours');
                // Continue polling after 1 second
                setTimeout(pollScanStatus, 1000);
            } else {
                // Scan finished
                if (status.status && (status.status.startsWith('Erreur') || status.status.includes('arrêté'))) {
                    updateScanStatus(false, status.status);
                    if (status.status.includes('arrêté')) {
                        Toast.info('Scan arrêté');
                    } else {
                        Toast.error(status.status);
                    }
                } else {
                    updateScanStatus(false, 'Scan terminé');
                    Toast.success('Scan terminé');
                }
                refreshResults();
            }
        } catch (error) {
            console.error("Polling error", error);
            setTimeout(pollScanStatus, 2000);
        }
    }

    // --- Fonctions utilitaires (conservées) ---

    // Mettre à jour le statut du scan
    // Mettre à jour le statut du scan et les boutons
    function updateScanStatus(inProgress, message) {
        const indicator = document.getElementById('scanStatusIndicator');
        const statusText = document.getElementById('scanStatusText');
        const statusDetail = document.getElementById('scanStatusDetail');
        const scanBtn = document.getElementById('scanBtn');
        const stopBtn = document.getElementById('stopBtn');

        if (inProgress) {
            indicator.style.backgroundColor = 'var(--warning-color)';
            indicator.style.animation = 'pulse 1s infinite';
            statusText.textContent = 'En cours';

            // Toggle buttons
            scanBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            stopBtn.disabled = false;
            stopBtn.innerHTML = '<i class="fas fa-stop"></i> Arrêter le Scan';

        } else {
            indicator.style.backgroundColor = 'var(--success-color)';
            indicator.style.animation = 'none';
            statusText.textContent = 'Prêt';

            // Toggle buttons
            scanBtn.style.display = 'block';
            scanBtn.disabled = false;
            stopBtn.style.display = 'none';
        }
        statusDetail.textContent = message;
    }

    // Charger et afficher les résultats
    async function refreshResults() {
        try {
            const hosts = await API.scanner.getHosts();
            const container = document.getElementById('resultsContainer');

            if (hosts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 2rem;"><i class="fas fa-inbox" style="font-size: 2rem; display: block; margin-bottom: 1rem; opacity: 0.5;"></i>Aucun hôte détecté</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table class="table"><thead><tr><th>Adresse IP</th><th>Nom d\'Hôte</th><th>Ports Ouverts</th><th>Détails</th></tr></thead><tbody>';

            hosts.forEach(host => {
                const portCount = Object.keys(host.ports).length;
                const portDetails = Object.entries(host.ports)
                    .map(([port, service]) => `${port}: ${service}`)
                    .join('<br>');

                html += `
                    <tr>
                        <td><code style="background-color: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 4px;">${host.ip_address}</code></td>
                        <td>${host.hostname || 'N/A'}</td>
                        <td><span class="badge badge-info">${portCount}</span></td>
                        <td>
                            <details style="cursor: pointer;">
                                <summary style="color: var(--primary-color);">Afficher</summary>
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: var(--bg-tertiary); border-radius: 4px; font-size: 0.85rem; color: var(--text-secondary);">
                                    ${portDetails || 'Aucun port ouvert'}
                                </div>
                            </details>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Erreur lors du chargement des résultats:', error);
            document.getElementById('resultsContainer').innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Erreur lors du chargement des résultats</div>';
        }
    }

    // Validation (Ces fonctions devraient être définies quelque part)
    function isValidCIDR(cidr) {
        // Validation basique (à améliorer pour la production)
        const regex = /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/;
        return regex.test(cidr);
    }

    function isValidIP(ip) {
        // Validation basique (à améliorer pour la production)
        const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
        return regex.test(ip);
    }

    // Charger les résultats au chargement de la page
    document.addEventListener('DOMContentLoaded', refreshResults);
</script>
{% endblock %}